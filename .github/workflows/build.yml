name: æ„å»ºå’Œå‘å¸ƒ

on:
  push:
    branches: [ main, master ]
    tags:
      - 'v*'
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    
    strategy:
      matrix:
        node-version: [18.x]
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: è®¾ç½® Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'
        
    - name: è®¾ç½® MSBuild
      uses: microsoft/setup-msbuild@v2
      
    - name: è®¾ç½® Python ç”¨äº node-gyp
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        
    - name: å®‰è£… Windows æ„å»ºå·¥å…·
      run: |
        npm install -g windows-build-tools@4.0.0 --quiet
      continue-on-error: true
      timeout-minutes: 10
      
    - name: é…ç½® npm ç”¨äº Windows
      run: |
        npm config set msvs_version 2017
        npm config set python python3
        
    - name: å®‰è£…ä¸»ä¾èµ–
      run: npm install
      
    - name: å®‰è£…åŸç”Ÿæ¨¡å—ä¾èµ–
      run: |
        cd src/native
        npm install
        
    - name: æ„å»ºåŸç”Ÿæ¨¡å—
      run: |
        cd src/native
        npx node-gyp configure --msvs_version=2017
        npx node-gyp build --release
        
    - name: éªŒè¯åŸç”Ÿæ¨¡å—
      run: |
        if (Test-Path "src/native/build/Release/high_priority_shortcut.node") {
          Write-Host "âœ… high_priority_shortcut.node built successfully"
        } else {
          Write-Error "âŒ high_priority_shortcut.node build failed"
          exit 1
        }
        if (Test-Path "src/native/build/Release/high_priority_topmost.node") {
          Write-Host "âœ… high_priority_topmost.node built successfully"
        } else {
          Write-Error "âŒ high_priority_topmost.node build failed"
          exit 1
        }
      shell: powershell
      
    - name: æ„å»º Electron åº”ç”¨ (ä¾¿æºç‰ˆ EXE)
      run: npx electron-builder --win portable --x64
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        
    - name: æ„å»º Electron åº”ç”¨ (ç›®å½•/ZIP)
      run: npx electron-builder --win dir --x64
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        
    - name: ä»ç›®å½•æ„å»ºåˆ›å»º ZIP
      run: |
        cd dist/win-unpacked
        Compress-Archive -Path * -DestinationPath "../teyvat-browser-win32-x64.zip"
        cd ../..
      shell: powershell
      
    - name: åˆ—å‡ºæ„å»ºè¾“å‡º
      run: |
        Write-Host "=== Build Output Directory ==="
        Get-ChildItem -Path "dist" -Recurse | Format-Table Name,Length,LastWriteTime
      shell: powershell
      
    - name: ä¸Šä¼ ä¾¿æºç‰ˆ EXE
      uses: actions/upload-artifact@v4
      with:
        name: teyvat-browser-portable-exe
        path: dist/*.exe
        retention-days: 30
        
    - name: ä¸Šä¼  ZIP åŒ…
      uses: actions/upload-artifact@v4
      with:
        name: teyvat-browser-zip
        path: dist/teyvat-browser-win32-x64.zip
        retention-days: 30
        
    - name: ä¸Šä¼ ç›®å½•æ„å»º
      uses: actions/upload-artifact@v4
      with:
        name: teyvat-browser-directory
        path: dist/win-unpacked/
        retention-days: 30

  release:
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    permissions:
      contents: write
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: ä¸‹è½½æ‰€æœ‰æ„å»ºäº§ç‰©
      uses: actions/download-artifact@v4
      
    - name: æ˜¾ç¤ºä¸‹è½½æ–‡ä»¶ç»“æ„
      run: ls -la -R
      
    - name: åˆ›å»ºå‘å¸ƒ
      uses: softprops/action-gh-release@v2
      with:
        name: æç“¦ç‰¹æµè§ˆå™¨ ${{ github.ref_name }}
        body: |
          ## ğŸ® æç“¦ç‰¹æµè§ˆå™¨ æ–°ç‰ˆæœ¬å‘å¸ƒï¼
          
          ### ğŸ“¦ ä¸‹è½½è¯´æ˜
          - **ä¾¿æºç‰ˆEXE**: `æç“¦ç‰¹æµè§ˆå™¨-ä¾¿æºç‰ˆ.exe` - å•ä¸ªexeæ–‡ä»¶ï¼ŒåŒå‡»å³å¯è¿è¡Œ
          - **å®Œæ•´ç‰ˆZIP**: `æç“¦ç‰¹æµè§ˆå™¨-å®Œæ•´ç‰ˆ.zip` - åŒ…å«æ‰€æœ‰æ–‡ä»¶çš„å‹ç¼©åŒ…
          
          ### âš ï¸ é‡è¦æé†’
          - **å¿…é¡»ä»¥ç®¡ç†å‘˜èº«ä»½è¿è¡Œ**ï¼Œæ‰èƒ½åœ¨æ¸¸æˆä¸­ä½¿ç”¨å¿«æ·é”®
          - é¦–æ¬¡è¿è¡Œå¯èƒ½éœ€è¦å‡ åˆ†é’Ÿæ¥åˆå§‹åŒ–
          - å»ºè®®æ·»åŠ åˆ°æ€æ¯’è½¯ä»¶ç™½åå•
          
          ### ğŸ†• é»˜è®¤å¿«æ·é”®
          - **F1**: æ’­æ”¾/æš‚åœ
          - **F2**: åé€€5ç§’  
          - **F3**: å‰è¿›5ç§’
          - **Insert**: æ˜¾ç¤º/éšè—æµè§ˆå™¨
          - **Ctrl+â†‘/â†“**: è°ƒèŠ‚é€æ˜åº¦
          
          ### ğŸ’¬ é—®é¢˜åé¦ˆ
          å¦‚æœ‰é—®é¢˜è¯·åŠ QQç¾¤ï¼š1003862782
          
          ---
          è‡ªåŠ¨æ„å»ºæ—¶é—´: ${{ github.event.head_commit.timestamp }}
        files: |
          teyvat-browser-portable-exe/*.exe
          teyvat-browser-zip/*.zip
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}